# æ·»åŠ æ–°åŠŸèƒ½æŒ‡å—

## ğŸ“‹ ç›®å½•

1. [å¼€å‘æµç¨‹æ¦‚è§ˆ](#å¼€å‘æµç¨‹æ¦‚è§ˆ)
2. [å®Œæ•´ç¤ºä¾‹ï¼šæ·»åŠ "äº§å“ç®¡ç†"åŠŸèƒ½](#å®Œæ•´ç¤ºä¾‹æ·»åŠ äº§å“ç®¡ç†åŠŸèƒ½)
3. [æ­¥éª¤è¯¦è§£](#æ­¥éª¤è¯¦è§£)
4. [å¸¸è§åœºæ™¯](#å¸¸è§åœºæ™¯)
5. [æ³¨æ„äº‹é¡¹](#æ³¨æ„äº‹é¡¹)

---

## å¼€å‘æµç¨‹æ¦‚è§ˆ

æ·»åŠ æ–°åŠŸèƒ½çš„å®Œæ•´æµç¨‹ï¼š

```
1. è®¾è®¡æ•°æ®æ¨¡å‹ (Model)
   â†“
2. åˆ›å»ºæ•°æ®åº“è¿ç§»æ–‡ä»¶ (Migration)
   â†“
3. å®šä¹‰æ•°æ®éªŒè¯ Schema
   â†“
4. å®ç°ä¸šåŠ¡é€»è¾‘ Controller
   â†“
5. ç¼–å†™ API è·¯ç”±
   â†“
6. æ³¨å†Œè·¯ç”±
   â†“
7. æµ‹è¯•åŠŸèƒ½
```

---

## å®Œæ•´ç¤ºä¾‹ï¼šæ·»åŠ "äº§å“ç®¡ç†"åŠŸèƒ½

### æ­¥éª¤ 1: è®¾è®¡æ•°æ®æ¨¡å‹

#### 1.1 åˆ›å»ºæ¨¡å‹æ–‡ä»¶

åœ¨ `app/models/system/admin.py` ä¸­æ·»åŠ æ¨¡å‹ï¼š

```python
class Product(BaseModel, TimestampMixin):
    """äº§å“æ¨¡å‹"""
    id = fields.IntField(pk=True, description="äº§å“ID")
    name = fields.CharField(max_length=100, description="äº§å“åç§°")
    price = fields.DecimalField(max_digits=10, decimal_places=2, description="ä»·æ ¼")
    description = fields.TextField(null=True, description="æè¿°")
    status = fields.CharEnumField(enum_type=StatusType, default=StatusType.enable, description="çŠ¶æ€")
    category_id = fields.IntField(null=True, description="åˆ†ç±»ID")
    
    # å…³è”å…³ç³»ï¼ˆå¦‚æœéœ€è¦ï¼‰
    category: fields.ForeignKeyRelation['Category'] = fields.ForeignKeyField(
        "app_system.Category", 
        related_name="products", 
        null=True
    )
    
    class Meta:
        table = "products"
        table_description = "äº§å“è¡¨"
        indexes = [
            ("name",),
            ("status",),
            ("category_id",),
        ]
```

#### 1.2 å¯¼å‡ºæ¨¡å‹

åœ¨ `app/models/system/__init__.py` ä¸­å¯¼å‡ºï¼š

```python
from .admin import Product

__all__ = [
    # ... å…¶ä»–æ¨¡å‹
    "Product",
]
```

#### 1.3 åˆ›å»ºæ•°æ®åº“è¿ç§»

```bash
# åœ¨é¡¹ç›®æ ¹ç›®å½•æ‰§è¡Œ
aerich migrate --name add_product

# åº”ç”¨è¿ç§»
aerich upgrade
```

**æ³¨æ„**: è¿ç§»æ–‡ä»¶ä¼šè‡ªåŠ¨ç”Ÿæˆåœ¨ `migrations/app_system/` ç›®å½•ä¸‹ã€‚

---

### æ­¥éª¤ 2: å®šä¹‰æ•°æ®éªŒè¯ Schema

#### 2.1 åˆ›å»º Schema æ–‡ä»¶

åˆ›å»º `app/schemas/products.py`:

```python
from typing import Annotated
from pydantic import BaseModel, Field
from decimal import Decimal

from app.models.system import StatusType


class ProductBase(BaseModel):
    """äº§å“åŸºç¡€ Schema"""
    name: Annotated[str | None, Field(alias="name", max_length=100, title="äº§å“åç§°")] = None
    price: Annotated[Decimal | None, Field(alias="price", title="ä»·æ ¼")] = None
    description: Annotated[str | None, Field(alias="description", title="æè¿°")] = None
    status: Annotated[StatusType | None, Field(alias="status", title="çŠ¶æ€")] = None
    category_id: Annotated[int | None, Field(alias="categoryId", title="åˆ†ç±»ID")] = None
    
    class Config:
        populate_by_name = True


class ProductSearch(ProductBase):
    """äº§å“æœç´¢ Schema"""
    current: Annotated[int | None, Field(description="é¡µç ", ge=1)] = 1
    size: Annotated[int | None, Field(description="æ¯é¡µæ•°é‡", ge=1, le=100)] = 10


class ProductCreate(ProductBase):
    """äº§å“åˆ›å»º Schema"""
    name: Annotated[str, Field(alias="name", max_length=100, title="äº§å“åç§°")]
    price: Annotated[Decimal, Field(alias="price", title="ä»·æ ¼", gt=0)]


class ProductUpdate(ProductBase):
    """äº§å“æ›´æ–° Schema"""
    ...


__all__ = ["ProductBase", "ProductSearch", "ProductCreate", "ProductUpdate"]
```

---

### æ­¥éª¤ 3: å®ç°ä¸šåŠ¡é€»è¾‘ Controller

#### 3.1 åˆ›å»º Controller æ–‡ä»¶

åˆ›å»º `app/controllers/product.py`:

```python
from app.core.crud import CRUDBase
from app.models.system import Product
from app.schemas.products import ProductCreate, ProductUpdate


class ProductController(CRUDBase[Product, ProductCreate, ProductUpdate]):
    """äº§å“ä¸šåŠ¡é€»è¾‘æ§åˆ¶å™¨"""
    
    def __init__(self):
        super().__init__(model=Product)
    
    async def get_by_name(self, name: str) -> Product | None:
        """æ ¹æ®åç§°è·å–äº§å“"""
        return await self.model.filter(name=name).first()
    
    async def get_by_category(self, category_id: int) -> list[Product]:
        """æ ¹æ®åˆ†ç±»è·å–äº§å“åˆ—è¡¨"""
        return await self.model.filter(category_id=category_id, status=StatusType.enable).all()


# åˆ›å»ºæ§åˆ¶å™¨å®ä¾‹
product_controller = ProductController()
```

#### 3.2 å¯¼å‡º Controller

åœ¨ `app/controllers/__init__.py` ä¸­å¯¼å‡ºï¼š

```python
from .product import product_controller

__all__ = [
    # ... å…¶ä»–æ§åˆ¶å™¨
    "product_controller",
]
```

---

### æ­¥éª¤ 4: ç¼–å†™ API è·¯ç”±

#### 4.1 åˆ›å»º API æ–‡ä»¶

åˆ›å»º `app/api/v1/system_manage/products.py`:

```python
from fastapi import APIRouter, Query
from tortoise.expressions import Q

from app.api.v1.utils import insert_log
from app.controllers.product import product_controller
from app.models.system import LogType, LogDetailType
from app.schemas.base import Success, SuccessExtra
from app.schemas.products import ProductSearch, ProductCreate, ProductUpdate

router = APIRouter()


@router.post("/products/all/", summary="æŸ¥çœ‹äº§å“åˆ—è¡¨")
async def get_products(obj_in: ProductSearch):
    """è·å–äº§å“åˆ—è¡¨ï¼ˆæ”¯æŒæœç´¢å’Œåˆ†é¡µï¼‰"""
    # æ„å»ºæŸ¥è¯¢æ¡ä»¶
    q = Q()
    if obj_in.name:
        q &= Q(name__contains=obj_in.name)
    if obj_in.status:
        q &= Q(status=obj_in.status)
    if obj_in.category_id:
        q &= Q(category_id=obj_in.category_id)
    
    # è°ƒç”¨ Controller è·å–æ•°æ®
    total, product_objs = await product_controller.list(
        page=obj_in.current,
        page_size=obj_in.size,
        search=q,
        order=["-id"]  # æŒ‰ ID å€’åº
    )
    
    # æ•°æ®è½¬æ¢
    records = []
    for product_obj in product_objs:
        record = await product_obj.to_dict()
        # å¦‚æœéœ€è¦å…³è”æ•°æ®ï¼Œä½¿ç”¨ prefetch_related
        # await product_obj.fetch_related("category")
        # if product_obj.category:
        #     record["category"] = await product_obj.category.to_dict()
        records.append(record)
    
    data = {"records": records}
    
    # è®°å½•æ—¥å¿—
    await insert_log(
        log_type=LogType.AdminLog,
        log_detail_type=LogDetailType.ProductGetList,  # éœ€è¦åœ¨ LogDetailType ä¸­æ·»åŠ 
        by_user_id=0
    )
    
    return SuccessExtra(data=data, total=total, current=obj_in.current, size=obj_in.size)


@router.get("/products/{product_id}", summary="æŸ¥çœ‹äº§å“è¯¦æƒ…")
async def get_product(product_id: int):
    """è·å–äº§å“è¯¦æƒ…"""
    product_obj = await product_controller.get(id=product_id)
    data = await product_obj.to_dict()
    
    await insert_log(
        log_type=LogType.AdminLog,
        log_detail_type=LogDetailType.ProductGetOne,
        by_user_id=0
    )
    
    return Success(data=data)


@router.post("/products", summary="åˆ›å»ºäº§å“")
async def create_product(product_in: ProductCreate):
    """åˆ›å»ºäº§å“"""
    # æ£€æŸ¥äº§å“åç§°æ˜¯å¦å·²å­˜åœ¨
    existing_product = await product_controller.get_by_name(product_in.name)
    if existing_product:
        return Success(code="4090", msg="äº§å“åç§°å·²å­˜åœ¨")
    
    # åˆ›å»ºäº§å“
    new_product = await product_controller.create(obj_in=product_in)
    
    await insert_log(
        log_type=LogType.AdminLog,
        log_detail_type=LogDetailType.ProductCreateOne,
        by_user_id=0
    )
    
    return Success(msg="åˆ›å»ºæˆåŠŸ", data={"created_id": new_product.id})


@router.patch("/products/{product_id}", summary="æ›´æ–°äº§å“")
async def update_product(product_id: int, product_in: ProductUpdate):
    """æ›´æ–°äº§å“"""
    # æ£€æŸ¥äº§å“æ˜¯å¦å­˜åœ¨
    product = await product_controller.get(id=product_id)
    
    # å¦‚æœæ›´æ–°åç§°ï¼Œæ£€æŸ¥æ˜¯å¦é‡å¤
    if product_in.name and product_in.name != product.name:
        existing_product = await product_controller.get_by_name(product_in.name)
        if existing_product:
            return Success(code="4090", msg="äº§å“åç§°å·²å­˜åœ¨")
    
    # æ›´æ–°äº§å“
    updated_product = await product_controller.update(id=product_id, obj_in=product_in)
    
    await insert_log(
        log_type=LogType.AdminLog,
        log_detail_type=LogDetailType.ProductUpdateOne,
        by_user_id=0
    )
    
    return Success(msg="æ›´æ–°æˆåŠŸ", data={"updated_id": product_id})


@router.delete("/products/{product_id}", summary="åˆ é™¤äº§å“")
async def delete_product(product_id: int):
    """åˆ é™¤äº§å“"""
    await product_controller.remove(id=product_id)
    
    await insert_log(
        log_type=LogType.AdminLog,
        log_detail_type=LogDetailType.ProductDeleteOne,
        by_user_id=0
    )
    
    return Success(msg="åˆ é™¤æˆåŠŸ", data={"deleted_id": product_id})


@router.delete("/products", summary="æ‰¹é‡åˆ é™¤äº§å“")
async def batch_delete_products(obj_in: CommonIds):
    """æ‰¹é‡åˆ é™¤äº§å“"""
    from app.schemas.base import CommonIds
    
    deleted_ids = []
    for product_id in obj_in.ids:
        product_obj = await product_controller.get(id=int(product_id))
        await product_obj.delete()
        deleted_ids.append(int(product_id))
    
    await insert_log(
        log_type=LogType.AdminLog,
        log_detail_type=LogDetailType.ProductBatchDeleteOne,
        by_user_id=0
    )
    
    return Success(msg="æ‰¹é‡åˆ é™¤æˆåŠŸ", data={"deleted_ids": deleted_ids})
```

#### 4.2 æ·»åŠ æ—¥å¿—ç±»å‹ï¼ˆå¦‚æœéœ€è¦ï¼‰

åœ¨ `app/models/system/utils.py` çš„ `LogDetailType` æšä¸¾ä¸­æ·»åŠ ï¼š

```python
class LogDetailType(str, Enum):
    # ... ç°æœ‰ç±»å‹
    
    # äº§å“ç›¸å…³æ—¥å¿—
    ProductGetList = "1701"
    ProductGetOne = "1711"
    ProductCreateOne = "1712"
    ProductUpdateOne = "1713"
    ProductDeleteOne = "1714"
    ProductBatchDeleteOne = "1715"
```

---

### æ­¥éª¤ 5: æ³¨å†Œè·¯ç”±

#### 5.1 åœ¨ system_manage æ¨¡å—ä¸­æ³¨å†Œ

åˆ›å»ºæˆ–ç¼–è¾‘ `app/api/v1/system_manage/__init__.py`:

```python
from fastapi import APIRouter
from .users import router as router_users
from .roles import router as router_roles
from .menus import router as router_menus
from .apis import router as router_apis
from .logs import router as router_logs
from .products import router as router_products  # æ–°å¢

router_system_manage = APIRouter()

router_system_manage.include_router(router_users, prefix="/users", tags=["ç”¨æˆ·ç®¡ç†"])
router_system_manage.include_router(router_roles, prefix="/roles", tags=["è§’è‰²ç®¡ç†"])
router_system_manage.include_router(router_menus, prefix="/menus", tags=["èœå•ç®¡ç†"])
router_system_manage.include_router(router_apis, prefix="/apis", tags=["APIç®¡ç†"])
router_system_manage.include_router(router_logs, prefix="/logs", tags=["æ—¥å¿—ç®¡ç†"])
router_system_manage.include_router(router_products, prefix="/products", tags=["äº§å“ç®¡ç†"])  # æ–°å¢
```

---

### æ­¥éª¤ 6: æ·»åŠ æƒé™æ§åˆ¶ï¼ˆå¯é€‰ï¼‰

å¦‚æœéœ€è¦æƒé™æ§åˆ¶ï¼Œåœ¨è·¯ç”±ä¸­æ·»åŠ ä¾èµ–ï¼š

```python
from app.core.dependency import DependAuth, DependPermission

@router.post("/products", summary="åˆ›å»ºäº§å“", dependencies=[DependAuth, DependPermission])
async def create_product(product_in: ProductCreate):
    ...
```

---

### æ­¥éª¤ 7: æµ‹è¯•åŠŸèƒ½

#### 7.1 å¯åŠ¨åº”ç”¨

```bash
python run.py
```

#### 7.2 æµ‹è¯• API

ä½¿ç”¨ curl æˆ– Postman æµ‹è¯•ï¼š

```bash
# åˆ›å»ºäº§å“
curl -X POST "http://localhost:8000/api/v1/system-manage/products" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "æµ‹è¯•äº§å“",
    "price": 99.99,
    "description": "è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•äº§å“"
  }'

# è·å–äº§å“åˆ—è¡¨
curl -X POST "http://localhost:8000/api/v1/system-manage/products/all/" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "current": 1,
    "size": 10
  }'
```

---

## æ­¥éª¤è¯¦è§£

### 1. æ¨¡å‹è®¾è®¡è¦ç‚¹

#### å­—æ®µç±»å‹é€‰æ‹©

```python
# å­—ç¬¦ä¸²å­—æ®µ
name = fields.CharField(max_length=100)  # æœ‰é•¿åº¦é™åˆ¶
description = fields.TextField()  # æ— é•¿åº¦é™åˆ¶

# æ•°å€¼å­—æ®µ
price = fields.DecimalField(max_digits=10, decimal_places=2)  # ç²¾ç¡®å°æ•°
quantity = fields.IntField()  # æ•´æ•°

# æ—¥æœŸæ—¶é—´
created_at = fields.DatetimeField(auto_now_add=True)  # åˆ›å»ºæ—¶è‡ªåŠ¨è®¾ç½®
updated_at = fields.DatetimeField(auto_now=True)  # æ›´æ–°æ—¶è‡ªåŠ¨è®¾ç½®

# æšä¸¾å­—æ®µ
status = fields.CharEnumField(enum_type=StatusType, default=StatusType.enable)

# JSON å­—æ®µ
metadata = fields.JSONField(null=True)  # å­˜å‚¨ JSON æ•°æ®

# å¸ƒå°”å­—æ®µ
is_active = fields.BooleanField(default=True)
```

#### å…³è”å…³ç³»

```python
# å¤–é”®å…³ç³»ï¼ˆå¤šå¯¹ä¸€ï¼‰
category: fields.ForeignKeyRelation['Category'] = fields.ForeignKeyField(
    "app_system.Category",
    related_name="products"
)

# å¤šå¯¹å¤šå…³ç³»
tags: fields.ManyToManyRelation['Tag'] = fields.ManyToManyField(
    "app_system.Tag",
    related_name="products"
)
```

#### ç´¢å¼•ä¼˜åŒ–

```python
class Meta:
    indexes = [
        ("name",),  # å•å­—æ®µç´¢å¼•
        ("status", "category_id"),  # å¤åˆç´¢å¼•
        ("name", "status"),  # å¤šå­—æ®µç´¢å¼•
    ]
```

---

### 2. Schema è®¾è®¡è¦ç‚¹

#### å­—æ®µåˆ«å

```python
# å‰ç«¯ä½¿ç”¨ camelCaseï¼Œåç«¯ä½¿ç”¨ snake_case
name: Annotated[str, Field(alias="productName")]

# æ”¯æŒåŒå‘è½¬æ¢
class Config:
    populate_by_name = True  # åŒæ—¶æ”¯æŒåˆ«åå’ŒåŸå
```

#### å­—æ®µéªŒè¯

```python
from pydantic import validator

class ProductCreate(BaseModel):
    name: str = Field(..., min_length=1, max_length=100)
    price: Decimal = Field(..., gt=0, description="ä»·æ ¼å¿…é¡»å¤§äº0")
    
    @validator('name')
    def validate_name(cls, v):
        if not v.strip():
            raise ValueError('äº§å“åç§°ä¸èƒ½ä¸ºç©º')
        return v.strip()
```

#### åµŒå¥—æ¨¡å‹

```python
class ProductCreate(BaseModel):
    name: str
    category: CategoryCreate  # åµŒå¥—æ¨¡å‹
    tags: list[TagCreate]  # åµŒå¥—åˆ—è¡¨
```

---

### 3. Controller è®¾è®¡è¦ç‚¹

#### ç»§æ‰¿ CRUDBase

```python
class ProductController(CRUDBase[Product, ProductCreate, ProductUpdate]):
    def __init__(self):
        super().__init__(model=Product)
```

#### è‡ªå®šä¹‰æŸ¥è¯¢æ–¹æ³•

```python
async def get_by_name(self, name: str) -> Product | None:
    """æ ¹æ®åç§°æŸ¥è¯¢"""
    return await self.model.filter(name=name).first()

async def get_by_status(self, status: StatusType) -> list[Product]:
    """æ ¹æ®çŠ¶æ€æŸ¥è¯¢åˆ—è¡¨"""
    return await self.model.filter(status=status).all()
```

#### é‡å†™åŸºç¡€æ–¹æ³•

```python
async def create(self, obj_in: ProductCreate) -> Product:
    """é‡å†™åˆ›å»ºæ–¹æ³•ï¼Œæ·»åŠ ä¸šåŠ¡é€»è¾‘"""
    # æ£€æŸ¥é‡å¤
    if await self.get_by_name(obj_in.name):
        raise HTTPException(code="4090", msg="äº§å“åç§°å·²å­˜åœ¨")
    
    # è°ƒç”¨çˆ¶ç±»æ–¹æ³•
    return await super().create(obj_in)
```

---

### 4. API è·¯ç”±è®¾è®¡è¦ç‚¹

#### RESTful è®¾è®¡

```python
# GET    /products          # è·å–åˆ—è¡¨ï¼ˆä¸æ¨èï¼‰
POST   /products/all/      # è·å–åˆ—è¡¨ï¼ˆæ”¯æŒå¤æ‚æœç´¢ï¼‰
GET    /products/{id}      # è·å–è¯¦æƒ…
POST   /products           # åˆ›å»º
PATCH  /products/{id}       # æ›´æ–°
DELETE /products/{id}      # åˆ é™¤
DELETE /products           # æ‰¹é‡åˆ é™¤
```

#### æŸ¥è¯¢æ¡ä»¶æ„å»º

```python
q = Q()
if obj_in.name:
    q &= Q(name__contains=obj_in.name)
if obj_in.status:
    q &= Q(status=obj_in.status)
if obj_in.price_min:
    q &= Q(price__gte=obj_in.price_min)
if obj_in.price_max:
    q &= Q(price__lte=obj_in.price_max)
```

#### ä¼˜åŒ– N+1 æŸ¥è¯¢

```python
# âŒ é”™è¯¯ï¼šN+1 æŸ¥è¯¢
for product in products:
    await product.fetch_related("category")  # æ¯ä¸ªäº§å“éƒ½æŸ¥è¯¢ä¸€æ¬¡

# âœ… æ­£ç¡®ï¼šé¢„åŠ è½½
products = await Product.all().prefetch_related("category")
```

#### äº‹åŠ¡å¤„ç†ï¼ˆé‡è¦ï¼‰

```python
from tortoise.transactions import in_transaction

@router.post("/products/batch")
async def batch_create(products: list[ProductCreate]):
    async with in_transaction() as conn:
        created_ids = []
        for product_in in products:
            product = await Product.create(**product_in.dict(), using_db=conn)
            created_ids.append(product.id)
        return Success(data={"created_ids": created_ids})
```

---

### 5. æƒé™æ§åˆ¶

#### æ·»åŠ æƒé™ä¾èµ–

```python
from app.core.dependency import DependAuth, DependPermission

@router.post("/products", dependencies=[DependAuth, DependPermission])
async def create_product(product_in: ProductCreate):
    ...
```

#### æƒé™é…ç½®

1. åœ¨æ•°æ®åº“ä¸­åˆ›å»ºèœå•ï¼ˆå¦‚æœéœ€è¦ï¼‰
2. åœ¨ API è¡¨ä¸­æ·»åŠ å¯¹åº”çš„ API è®°å½•ï¼ˆè‡ªåŠ¨å‘ç°ï¼‰
3. ä¸ºè§’è‰²åˆ†é… API æƒé™

---

## å¸¸è§åœºæ™¯

### åœºæ™¯ 1: æ·»åŠ å…³è”æ•°æ®

```python
# åˆ›å»ºäº§å“å¹¶å…³è”åˆ†ç±»
@router.post("/products")
async def create_product(product_in: ProductCreate):
    product = await product_controller.create(obj_in=product_in)
    
    # å…³è”åˆ†ç±»
    if product_in.category_id:
        category = await Category.get(id=product_in.category_id)
        await product.category.set(category)
    
    return Success(data={"created_id": product.id})
```

### åœºæ™¯ 2: æ–‡ä»¶ä¸Šä¼ 

```python
from fastapi import UploadFile, File

@router.post("/products/{product_id}/image")
async def upload_image(product_id: int, file: UploadFile = File(...)):
    # ä¿å­˜æ–‡ä»¶
    file_path = f"static/products/{product_id}_{file.filename}"
    with open(file_path, "wb") as f:
        f.write(await file.read())
    
    # æ›´æ–°äº§å“
    product = await product_controller.get(id=product_id)
    product.image_url = f"/static/products/{product_id}_{file.filename}"
    await product.save()
    
    return Success(data={"image_url": product.image_url})
```

### åœºæ™¯ 3: å¯¼å‡ºæ•°æ®

```python
from fastapi.responses import StreamingResponse
import csv
import io

@router.get("/products/export")
async def export_products():
    products = await Product.all()
    
    # ç”Ÿæˆ CSV
    output = io.StringIO()
    writer = csv.writer(output)
    writer.writerow(["ID", "åç§°", "ä»·æ ¼", "çŠ¶æ€"])
    
    for product in products:
        writer.writerow([product.id, product.name, product.price, product.status.value])
    
    output.seek(0)
    return StreamingResponse(
        iter([output.getvalue()]),
        media_type="text/csv",
        headers={"Content-Disposition": "attachment; filename=products.csv"}
    )
```

### åœºæ™¯ 4: æ‰¹é‡æ“ä½œ

```python
@router.post("/products/batch")
async def batch_create(products: list[ProductCreate]):
    async with in_transaction() as conn:
        created_ids = []
        for product_in in products:
            product = await Product.create(**product_in.dict(), using_db=conn)
            created_ids.append(product.id)
        return Success(data={"created_ids": created_ids})
```

---

## æ³¨æ„äº‹é¡¹

### 1. æ•°æ®åº“è¿ç§»

- âœ… ä¿®æ”¹æ¨¡å‹åå¿…é¡»åˆ›å»ºè¿ç§»æ–‡ä»¶
- âœ… è¿ç§»å‰å¤‡ä»½æ•°æ®åº“
- âœ… æµ‹è¯•ç¯å¢ƒå…ˆæµ‹è¯•è¿ç§»

### 2. æ•°æ®éªŒè¯

- âœ… Schema ä¸­å®šä¹‰éªŒè¯è§„åˆ™
- âœ… ä½¿ç”¨ Pydantic çš„éªŒè¯å™¨
- âœ… æ£€æŸ¥å¿…å¡«å­—æ®µ

### 3. æ€§èƒ½ä¼˜åŒ–

- âœ… é¿å… N+1 æŸ¥è¯¢
- âœ… ä½¿ç”¨ç´¢å¼•ä¼˜åŒ–æŸ¥è¯¢
- âœ… åˆç†ä½¿ç”¨ç¼“å­˜
- âœ… æ‰¹é‡æ“ä½œä½¿ç”¨äº‹åŠ¡

### 4. é”™è¯¯å¤„ç†

- âœ… ç»Ÿä¸€ä½¿ç”¨å¼‚å¸¸æˆ–å“åº”å¯¹è±¡
- âœ… æä¾›æ˜ç¡®çš„é”™è¯¯ä¿¡æ¯
- âœ… è®°å½•é”™è¯¯æ—¥å¿—

### 5. å®‰å…¨æ€§

- âœ… æ·»åŠ æƒé™æ§åˆ¶
- âœ… éªŒè¯ç”¨æˆ·è¾“å…¥
- âœ… é˜²æ­¢ SQL æ³¨å…¥ï¼ˆä½¿ç”¨ ORMï¼‰
- âœ… é˜²æ­¢ XSSï¼ˆéªŒè¯è¾“å…¥ï¼‰

### 6. æ—¥å¿—è®°å½•

- âœ… è®°å½•å…³é”®æ“ä½œ
- âœ… ä½¿ç”¨ç»Ÿä¸€çš„æ—¥å¿—ç±»å‹
- âœ… åŒ…å«ç”¨æˆ·ä¿¡æ¯

---

## æ£€æŸ¥æ¸…å•

æ·»åŠ æ–°åŠŸèƒ½åï¼Œè¯·æ£€æŸ¥ï¼š

- [ ] æ¨¡å‹å®šä¹‰å®Œæ•´ï¼ˆå­—æ®µã€ç´¢å¼•ã€å…³è”ï¼‰
- [ ] åˆ›å»ºäº†æ•°æ®åº“è¿ç§»æ–‡ä»¶
- [ ] Schema å®šä¹‰å®Œæ•´ï¼ˆBase, Create, Update, Searchï¼‰
- [ ] Controller å®ç°äº†ä¸šåŠ¡é€»è¾‘
- [ ] API è·¯ç”±å·²æ³¨å†Œ
- [ ] æ·»åŠ äº†æƒé™æ§åˆ¶ï¼ˆå¦‚éœ€è¦ï¼‰
- [ ] æ·»åŠ äº†æ—¥å¿—è®°å½•
- [ ] æµ‹è¯•äº†æ‰€æœ‰åŠŸèƒ½
- [ ] ä¼˜åŒ–äº†æŸ¥è¯¢æ€§èƒ½
- [ ] å¤„ç†äº†é”™è¯¯æƒ…å†µ

---

## å¿«é€Ÿå‚è€ƒ

### æ–‡ä»¶åˆ›å»ºé¡ºåº

1. `app/models/system/admin.py` - æ·»åŠ æ¨¡å‹
2. `migrations/` - åˆ›å»ºè¿ç§»ï¼ˆå‘½ä»¤ï¼‰
3. `app/schemas/products.py` - åˆ›å»º Schema
4. `app/controllers/product.py` - åˆ›å»º Controller
5. `app/api/v1/system_manage/products.py` - åˆ›å»º API
6. `app/api/v1/system_manage/__init__.py` - æ³¨å†Œè·¯ç”±

### å¸¸ç”¨å‘½ä»¤

```bash
# åˆ›å»ºè¿ç§»
aerich migrate --name add_product

# åº”ç”¨è¿ç§»
aerich upgrade

# å›æ»šè¿ç§»
aerich downgrade

# å¯åŠ¨åº”ç”¨
python run.py
```

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**æœ€åæ›´æ–°**: 2025-11-06

