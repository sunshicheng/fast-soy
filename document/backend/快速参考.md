# åç«¯é¡¹ç›®å¿«é€Ÿå‚è€ƒ

## ğŸ“ ç›®å½•ç»“æ„é€ŸæŸ¥

### æ ¸å¿ƒç›®å½•

| ç›®å½• | ä½œç”¨ | å…³é”®æ–‡ä»¶ |
|------|------|---------|
| `app/__init__.py` | åº”ç”¨å…¥å£ | åˆ›å»º FastAPI åº”ç”¨ |
| `app/api/` | API è·¯ç”±å±‚ | å®šä¹‰ HTTP è·¯ç”± |
| `app/controllers/` | ä¸šåŠ¡é€»è¾‘å±‚ | å°è£…ä¸šåŠ¡é€»è¾‘ |
| `app/models/` | æ•°æ®æ¨¡å‹å±‚ | å®šä¹‰æ•°æ®åº“æ¨¡å‹ |
| `app/schemas/` | æ•°æ®éªŒè¯å±‚ | Pydantic Schema |
| `app/core/` | æ ¸å¿ƒåŠŸèƒ½ | CRUDã€ä¾èµ–æ³¨å…¥ã€å¼‚å¸¸å¤„ç† |
| `app/settings/` | é…ç½®ç®¡ç† | åº”ç”¨é…ç½® |
| `app/utils/` | å·¥å…·å‡½æ•° | é€šç”¨å·¥å…· |

---

## ğŸ”‘ å…³é”®æ–‡ä»¶è¯´æ˜

### åº”ç”¨å…¥å£

```
app/__init__.py              # FastAPI åº”ç”¨åˆ›å»ºå’Œåˆå§‹åŒ–
run.py                       # å¯åŠ¨è„šæœ¬
```

### è·¯ç”±å±‚

```
app/api/v1/
â”œâ”€â”€ auth/auth.py             # è®¤è¯ API
â”œâ”€â”€ route/route.py          # è·¯ç”± API
â””â”€â”€ system_manage/
    â”œâ”€â”€ users.py            # ç”¨æˆ·ç®¡ç†
    â”œâ”€â”€ roles.py            # è§’è‰²ç®¡ç†
    â”œâ”€â”€ menus.py            # èœå•ç®¡ç†
    â””â”€â”€ apis.py             # API ç®¡ç†
```

### ä¸šåŠ¡å±‚

```
app/controllers/
â”œâ”€â”€ user.py                 # ç”¨æˆ·ä¸šåŠ¡é€»è¾‘
â”œâ”€â”€ role.py                 # è§’è‰²ä¸šåŠ¡é€»è¾‘
â”œâ”€â”€ menu.py                 # èœå•ä¸šåŠ¡é€»è¾‘
â””â”€â”€ api.py                  # API ä¸šåŠ¡é€»è¾‘
```

### æ•°æ®å±‚

```
app/models/system/
â”œâ”€â”€ admin.py                # ä¸šåŠ¡æ¨¡å‹ï¼ˆUser, Role, Menu ç­‰ï¼‰
â””â”€â”€ utils.py                # åŸºç¡€æ¨¡å‹å’Œæšä¸¾
```

---

## ğŸ› ï¸ å¸¸ç”¨å‘½ä»¤

```bash
# å¯åŠ¨å¼€å‘æœåŠ¡å™¨
python run.py

# åˆ›å»ºæ•°æ®åº“è¿ç§»
aerich migrate --name your_migration_name

# åº”ç”¨è¿ç§»
aerich upgrade

# å›æ»šè¿ç§»
aerich downgrade

# åˆå§‹åŒ–æ•°æ®åº“
aerich init-db

# æŸ¥çœ‹è¿ç§»å†å²
aerich history
```

---

## ğŸ“ å¼€å‘æµç¨‹

### æ·»åŠ æ–°åŠŸèƒ½

1. **åˆ›å»ºæ¨¡å‹** â†’ `app/models/system/admin.py`
2. **åˆ›å»ºè¿ç§»** â†’ `aerich migrate --name xxx`
3. **åˆ›å»º Schema** â†’ `app/schemas/xxx.py`
4. **åˆ›å»º Controller** â†’ `app/controllers/xxx.py`
5. **åˆ›å»º API** â†’ `app/api/v1/system_manage/xxx.py`
6. **æ³¨å†Œè·¯ç”±** â†’ `app/api/v1/system_manage/__init__.py`

### ä¿®æ”¹ç°æœ‰åŠŸèƒ½

1. **ä¿®æ”¹æ¨¡å‹** â†’ `app/models/system/admin.py`
2. **åˆ›å»ºè¿ç§»** â†’ `aerich migrate --name xxx`
3. **æ›´æ–° Schema** â†’ `app/schemas/xxx.py`
4. **æ›´æ–° Controller** â†’ `app/controllers/xxx.py`
5. **æ›´æ–° API** â†’ `app/api/v1/system_manage/xxx.py`

---

## ğŸ¯ å¸¸ç”¨ä»£ç ç‰‡æ®µ

### CRUD æ“ä½œ

```python
# è·å–å•ä¸ªå¯¹è±¡
product = await product_controller.get(id=1)

# åˆ†é¡µæŸ¥è¯¢
total, products = await product_controller.list(
    page=1,
    page_size=10,
    search=Q(status=StatusType.enable),
    order=["-id"]
)

# åˆ›å»º
product = await product_controller.create(obj_in=ProductCreate(...))

# æ›´æ–°
product = await product_controller.update(id=1, obj_in=ProductUpdate(...))

# åˆ é™¤
await product_controller.remove(id=1)
```

### æŸ¥è¯¢æ¡ä»¶æ„å»º

```python
from tortoise.expressions import Q

q = Q()
if name:
    q &= Q(name__contains=name)
if status:
    q &= Q(status=status)
if price_min:
    q &= Q(price__gte=price_min)
```

### å…³è”æŸ¥è¯¢

```python
# é¢„åŠ è½½å…³è”æ•°æ®ï¼ˆé¿å… N+1ï¼‰
products = await Product.all().prefetch_related("category")

# è·å–å…³è”æ•°æ®
await product.fetch_related("category")
category = product.category
```

### äº‹åŠ¡å¤„ç†

```python
from tortoise.transactions import in_transaction

async with in_transaction() as conn:
    product = await Product.create(**data, using_db=conn)
    await product.category.set(category, using_db=conn)
```

### å“åº”æ ¼å¼

```python
from app.schemas.base import Success, SuccessExtra, Fail

# æˆåŠŸå“åº”ï¼ˆå•ä¸ªå¯¹è±¡ï¼‰
return Success(data=product_dict)

# æˆåŠŸå“åº”ï¼ˆåˆ—è¡¨ï¼Œå¸¦åˆ†é¡µï¼‰
return SuccessExtra(
    data={"records": records},
    total=total,
    current=1,
    size=10
)

# å¤±è´¥å“åº”
return Fail(code="4090", msg="äº§å“åç§°å·²å­˜åœ¨")
```

### è®¤è¯å’Œæƒé™

```python
from app.core.dependency import DependAuth, DependPermission

@router.get("/products", dependencies=[DependAuth, DependPermission])
async def get_products():
    # éœ€è¦ç™»å½•å’Œæƒé™
    ...
```

### æ—¥å¿—è®°å½•

```python
from app.api.v1.utils import insert_log
from app.models.system import LogType, LogDetailType

await insert_log(
    log_type=LogType.AdminLog,
    log_detail_type=LogDetailType.ProductCreateOne,
    by_user_id=0  # 0 è¡¨ç¤ºä»ä¸Šä¸‹æ–‡è·å–
)
```

### è·å–å½“å‰ç”¨æˆ·

```python
from app.core.ctx import CTX_USER_ID

user_id = CTX_USER_ID.get()
user = await user_controller.get(id=user_id)
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [é¡¹ç›®ç»“æ„è¯´æ˜](./é¡¹ç›®ç»“æ„è¯´æ˜.md) - è¯¦ç»†çš„é¡¹ç›®ç»“æ„è¯´æ˜
- [æ·»åŠ æ–°åŠŸèƒ½æŒ‡å—](./æ·»åŠ æ–°åŠŸèƒ½æŒ‡å—.md) - æ·»åŠ æ–°åŠŸèƒ½çš„å®Œæ•´æ­¥éª¤

---

## âš ï¸ å¸¸è§é—®é¢˜

### Q: å¦‚ä½•æ·»åŠ æ•°æ®åº“å­—æ®µï¼Ÿ

A: 
1. ä¿®æ”¹æ¨¡å‹æ·»åŠ å­—æ®µ
2. è¿è¡Œ `aerich migrate --name add_field`
3. è¿è¡Œ `aerich upgrade`

### Q: å¦‚ä½•æ·»åŠ å…³è”å…³ç³»ï¼Ÿ

A: 
```python
# åœ¨æ¨¡å‹ä¸­ä½¿ç”¨ ForeignKeyField æˆ– ManyToManyField
category: fields.ForeignKeyRelation['Category'] = fields.ForeignKeyField(...)
tags: fields.ManyToManyRelation['Tag'] = fields.ManyToManyField(...)
```

### Q: å¦‚ä½•å¤„ç† N+1 æŸ¥è¯¢ï¼Ÿ

A: 
```python
# ä½¿ç”¨ prefetch_related é¢„åŠ è½½
products = await Product.all().prefetch_related("category")
```

### Q: å¦‚ä½•æ·»åŠ æƒé™æ§åˆ¶ï¼Ÿ

A: 
```python
# åœ¨è·¯ç”±ä¸­æ·»åŠ ä¾èµ–
@router.post("/products", dependencies=[DependAuth, DependPermission])
```

### Q: å¦‚ä½•æ·»åŠ äº‹åŠ¡ï¼Ÿ

A: 
```python
from tortoise.transactions import in_transaction

async with in_transaction() as conn:
    # ä½¿ç”¨ using_db=conn
    ...
```

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**æœ€åæ›´æ–°**: 2025-11-06

